<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notion Pixel Clock Full</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <style>
    /* ★★★ 기존 디자인 CSS 그대로 유지 ★★★ */
    :root{
      --panel:#111319;
      --panel2:#0f1117;
      --line:#2a2f3a;
      --line2:#3a4150;
      --text:#e9eef7;
      --muted:#a7b0c2;
      --accent:#7cc7ff;
    }

    * { box-sizing:border-box; }
    
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%; 
      background: var(--panel);
      color: var(--text);
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Press Start 2P", monospace;
      overflow: hidden;
    }

    .wrap {
      width: 100%; height: 100%; 
      background: var(--panel);
      border: 2px solid var(--line2);
      display: flex;
      flex-direction: column;
    }

    .top {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      padding: 8px; border-bottom: 2px solid var(--line2);
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      flex: 0 0 auto; 
    }

    .chip {
      height: 24px; padding: 0 8px; border: 2px solid var(--line2);
      background: #0e1016; color: var(--text); font-size: 9px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; user-select: none;
    }
    .chip:hover { border-color: var(--accent); }
    .chip.on { border-color: var(--accent); color: var(--accent); box-shadow: inset 0 0 0 2px rgba(124,199,255,.12); }

    .title {
      font-size: 9px; color: var(--muted); letter-spacing: 0.5px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      flex: 1; text-align: right;
    }

    .main {
      flex: 1; 
      display: flex; 
      padding: 10px; gap: 10px;
      min-height: 0;
    }

    .leftBox {
      flex: 1; 
      border: 2px solid var(--line); background: #0b0c10;
      padding: 12px; display: flex; flex-direction: column; justify-content: center;
      overflow: hidden; min-width: 0;
    }

    .dateRow {
      font-size: 10px; color: var(--muted); margin-bottom: 8px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .timeRow {
      display: flex; align-items: center; gap: 10px;
      white-space: nowrap; overflow: hidden;
    }

    .time {
      font-size: 20px; 
      color: var(--text); letter-spacing: 1px;
      padding: 2px 0 6px;
    }

    .cursor {
      font-size: 16px; color: var(--accent); padding: 2px 0 6px;
      user-select: none; pointer-events: none;
    }

    .note {
      margin-top: 10px; font-size: 10px; 
      color: rgba(233,238,247,.75);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .rightBox {
      width: 120px; flex-shrink: 0;
      border: 2px solid var(--line); background: #0b0c10;
      padding: 8px; display: flex; flex-direction: column; justify-content: center; gap: 8px;
    }

    .meterLabel { font-size: 8px; color: var(--muted); opacity: .95; }
    .meter {
      height: 12px; border: 2px solid var(--line2); background: #0e1016;
      position: relative; overflow: hidden;
    }
    .bar { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: var(--accent); transition: width .2s ease; }
    .meterText {
      font-size: 10px; font-weight: 900; color: var(--accent);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-height: 12px;
      letter-spacing: 0.5px;
    }

    @media (max-width: 300px) { .rightBox { display: none; } }
  </style>
</head>

<body>
  <div class="wrap" id="wrap">
    <div class="top">
      <button class="chip on" id="modeBtn" title="12/24 토글">24H</button>
      <div class="title">PIXEL CLOCK<span id="offlineBadge" style="display:none; margin-left:6px; font-size:8px; color:#ffa94d;">[테스트]</span></div>
    </div>

    <div class="main">
      <div class="leftBox">
        <div class="dateRow" id="dateText">LOADING...</div>
        <div class="timeRow">
          <div class="time" id="timeText">00:00</div>
          <div class="cursor" id="cursor">■</div>
        </div>
        <div class="note" id="noteText">할 일 확인 중...</div>
      </div>

      <div class="rightBox">
        <div class="meterLabel">DAY</div>
        <div class="meter"><div class="bar" id="dayBar"></div></div>

        <div class="meterLabel">TASK 진행률</div>
        <div class="meter"><div class="bar" id="taskBar"></div></div>
        <div class="meterText" id="taskPctText">0/0 · 0%</div>
      </div>
    </div>
  </div>

<script>
    const $ = (s) => document.querySelector(s);

    // ✅ 오프라인 모드: ?offline=1 → Notion API 호출 안 함 (투두와 동일 localStorage 사용)
    const OFFLINE_MODE = window.location.search.includes('offline=1');
    const OFFLINE_KEY = "missionlog_offline_tasks_v1";

    const dateText   = $("#dateText");
    const timeText   = $("#timeText");
    const cursorEl   = $("#cursor");
    const noteText   = $("#noteText");
    const dayBar     = $("#dayBar");
    const taskBar    = $("#taskBar");
    const taskPctText = $("#taskPctText");
    const modeBtn    = $("#modeBtn");

    const state = { is24h: true };
    const DOW_KR = ["일","월","화","수","목","금","토"];
    
    let notionStats = { done: 0, total: 0 };
    let syncInFlight = false; // ✅ 중복 호출 방지 플래그

  
function isDone(v){
  if (v === true) return true;
  if (v === false) return false;

  if (typeof v === "string") {
    return ["true","done","yes","1","완료"].includes(v.toLowerCase());
  }
  if (typeof v === "number") return v === 1;

  if (v && typeof v === "object") {
    if ("checkbox" in v) return !!v.checkbox;
    if ("value" in v) return !!v.value;
  }
  return false;
}

    // ★ [연동 핵심] 투두/캘린더와 동일한 KST 날짜 생성 함수
function getTodayISO() {
  return new Date().toLocaleDateString('sv-SE', { timeZone: 'Asia/Seoul' });
}

  const PENDING_KEY = "missionlog_pendingTasks_v1";
  
  function loadPendingTodayCount(today){
  try{
    const pending = JSON.parse(localStorage.getItem(PENDING_KEY) || "{}");
    const arr = Array.isArray(pending[today]) ? pending[today] : [];
    return {
      total: arr.length,
      done: arr.filter(t => isDone(t?.done)).length
    };
  }catch(_){
    return { total: 0, done: 0 };
  }
}

  const bc = new BroadcastChannel("missionlog_bus_v1");

// 같은 이벤트가 연속으로 올 때 1번만 처리(가벼운 쓰로틀)
let _bcTimer = null;

    bc.onmessage = (ev) => {
      const t = ev?.data?.type;
    
      if (t === "TASK_ADDED") {
        const today = getTodayISO();
        let p = { total: 0, done: 0 };
        if (OFFLINE_MODE) {
          const store = JSON.parse(localStorage.getItem(OFFLINE_KEY) || "{}");
          const arr = Array.isArray(store[today]) ? store[today] : [];
          p = { total: arr.length, done: arr.filter(x => isDone(x?.done)).length };
        } else {
          p = loadPendingTodayCount(today);
        }
        notionStats.total = Math.max(notionStats.total, p.total);
        notionStats.done = Math.max(notionStats.done, p.done);
        updateTaskUI();
        clearTimeout(_bcTimer);
        _bcTimer = setTimeout(fetchNotionData, 200);
        return;
      }
    
      if (t !== "TASKS_UPDATED") return;
    
      clearTimeout(_bcTimer);
      _bcTimer = setTimeout(() => {
        if (noteText) noteText.textContent = "업데이트 중...";
        fetchNotionData();
      }, 50);
    };


    async function fetchNotionData() {
      if (syncInFlight) return;
      syncInFlight = true;
      try {
        if (noteText) noteText.textContent = OFFLINE_MODE ? "테스트 모드" : "동기화 중...";
        
        if (OFFLINE_MODE) {
          const today = getTodayISO();
          const store = JSON.parse(localStorage.getItem(OFFLINE_KEY) || "{}");
          const arr = Array.isArray(store[today]) ? store[today] : [];
          notionStats.total = arr.length;
          notionStats.done = arr.filter(t => isDone(t?.done)).length;
          updateTaskUI();
          syncInFlight = false;
          return;
        }
        
        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), 8000);
        const res = await fetch('/api/notion', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Cache-Control': 'no-store'
          },
          cache: "no-store",
          body: JSON.stringify({ action: 'fetch' }),
          signal: ctrl.signal
        });
        
        clearTimeout(timer);
    
        if (!res.ok) {
          console.error("Clock API HTTP error:", res.status);
          if (noteText) noteText.textContent = `동기화 실패(HTTP ${res.status})`;
          return;
        }
    
        const data = await res.json().catch(() => null);
        if (!data?.success) {
          console.error("Clock API payload error:", data);
          if (noteText) noteText.textContent = "동기화 실패(payload)";
          return;
        }
    
      const today = getTodayISO();
      
      // ✅ date 포맷이 YYYY-MM-DD / YYYY-MM-DDT... 섞여와도 통일
      const todayTasks = (data.tasks || [])
        .filter(t => String(t.date || "").slice(0,10) === today);
      
      // ✅ pending(로컬) 오버레이 합산
      const p = loadPendingTodayCount(today);
      
      notionStats.total = todayTasks.length + p.total;
      notionStats.done  = todayTasks.filter(t => isDone(t?.done)).length + p.done;
      
      updateTaskUI();
        
      } catch (err) {
        console.error("Clock Sync Error:", err);
        if (noteText) noteText.textContent = "동기화 실패(네트워크)";
      } finally {
        syncInFlight = false;
      }
    }


    // ★ [UI 반영] 한글 문구 적용 완료
    function updateTaskUI() {
        const { done, total } = notionStats;
        const pct = total === 0 ? 0 : Math.round((done / total) * 100);
        
        if (taskBar) taskBar.style.width = `${pct}%`;
        if (taskPctText) taskPctText.textContent = `${done}/${total} · ${pct}%`;  
        
        if (noteText) {
            if (total === 0) {
                noteText.textContent = "오늘의 퀘스트 없음";
            } else {
                noteText.textContent = pct === 100 ? "모든 임무 완료! ★" : `진행중: ${done}/${total} 완료`;
            }
        }
    }

    // 시계 매초 업데이트
    function tick(){
        const d = new Date();
        const dow = DOW_KR[d.getDay()];

        dateText.textContent = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} (${dow})`;
        timeText.textContent = formatTime(d);
        cursorEl.style.opacity = (d.getSeconds() % 2 === 0) ? "1" : "0.15";
        dayBar.style.width = `${Math.round(calcDayProgress(d) * 100)}%`;
    }

    function formatTime(d){
        let h = d.getHours();
        const m = d.getMinutes();
        if(!state.is24h){
            const ampm = h < 12 ? "AM" : "PM";
            h = h % 12 || 12;
            return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")} ${ampm}`;
        }
        return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
    }

    function calcDayProgress(d){
        const total = 24*60*60;
        const now = d.getHours()*3600 + d.getMinutes()*60 + d.getSeconds();
        return Math.max(0, Math.min(1, now/total));
    }

    modeBtn.onclick = (e) => {
        e.preventDefault();
        state.is24h = !state.is24h;
        modeBtn.textContent = state.is24h ? "24H" : "12H";
        modeBtn.classList.toggle("on", state.is24h);
        tick();
    };

    // 초기 실행
    if (OFFLINE_MODE) document.getElementById("offlineBadge").style.display = "inline";
    tick();
    fetchNotionData();

    // 타이머 설정
    setInterval(tick, 1000);
    setInterval(fetchNotionData, 15000);
  </script>
</body>
</html>
