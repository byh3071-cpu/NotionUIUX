  <!DOCTYPE html>
  <html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notion Pixel Calendar</title>
  
    <link href="https://fonts.googleapis.com/css2?family=Silkscreen&family=Noto+Sans+KR:wght@700&display=swap" rel="stylesheet">
  
    <style>
      /* todo/scheduleê³¼ ë™ì¼í•œ ë””ìì¸ */
      :root{
        --bg-color: #0f1115; --border-color: #3b4261; --accent-color: #82aaff; --text-color: #dbe6f5; --dim-color: #1e222a;
        --today:#ffe08a; --sun:#ff8f8f; --sat:#8fb6ff; --pink: #ff6fb1;
        --w: 360px; --h: 460px; --cell: 46px; --gap: 4px;
        --bottomBarH: 46px;
      }
  
      *{ box-sizing:border-box; }
      html,body{
        margin:0; padding:0; width:100%; height:100%;
        background: var(--bg-color); color: var(--text-color);
        font-family: 'Silkscreen', cursive;
        overflow:hidden;
      }
  
      .stage{ width:100%; height:100%; display:flex; justify-content:center; align-items:center; }
      .wrap{ width:var(--w); height:var(--h); background:var(--bg-color); border:2px solid var(--border-color); overflow:hidden; position:relative; }
  
      .topbar{ display:flex; align-items:center; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border-color); background: rgba(59, 66, 97, 0.2); gap:6px; }
      .leftBtns, .rightBtns{ display:flex; gap:6px; align-items:center; }
      .btn{ height:32px; padding:0 10px; background: transparent; color: var(--text-color); border:1px solid var(--border-color); cursor:pointer; font-size:10px; font-family: 'Silkscreen'; display:flex; align-items:center; justify-content:center; }
      .btn:hover{ border-color: var(--accent-color); background: rgba(130, 170, 255, 0.15); }
      .monthTitle{ flex:1; text-align:center; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  
      .dow{ display:grid; grid-template-columns: repeat(7, 1fr); gap: var(--gap); padding:8px 8px 6px; border-bottom:2px solid var(--border-color); background: rgba(59, 66, 97, 0.15); }
      .dow div{ text-align:center; font-size:9px; color: var(--accent-color); opacity: 0.8; padding:6px 0; border:1px solid var(--border-color); background: rgba(30, 34, 42, 0.4); }
      .dow .sunHead{ color: var(--sun); border-color: rgba(255,143,143,.45); }
      .dow .satHead{ color: var(--sat); border-color: rgba(143,182,255,.45); }
  
      .grid{ padding:8px; display:grid; grid-template-columns: repeat(7, 1fr); gap: var(--gap); }
  
      .day{ height: var(--cell); border:1px solid var(--border-color); background: rgba(30, 34, 42, 0.4); position:relative; cursor:pointer; display:flex; padding:6px; }
      .day.disabled{ opacity: 0.5; cursor:default; background: rgba(0,0,0,.25); border-color: rgba(59, 66, 97, 0.5); }
      .day.disabled .num{ color: #888; }
      .day.today{ border-color: var(--today) !important; box-shadow: inset 0 0 0 2px rgba(255,224,138,.3); }
      .day.today .num{ color: var(--today); font-weight: 900; }
  
      .num{ font-size:10px; color: var(--text-color); }
      .day.sun:not(.disabled) { border-color: rgba(255,143,143,.40); }
      .day.sun:not(.disabled) .num { color: var(--sun); }
      .day.sat:not(.disabled) { border-color: rgba(143,182,255,.40); }
      .day.sat:not(.disabled) .num { color: var(--sat); }
  
      .eventMark{
        position:absolute;
        right:4px;
        top:3px;
        width:12px;
        height:12px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:10px;
        line-height:1;
        font-weight:900;
        color: var(--pink);
        opacity:.95;
        text-shadow: 0 1px 0 rgba(0,0,0,.65);
        pointer-events:none;
      }
  
      .todoBadge{ 
        position:absolute;
        left:0;
        bottom:0;
        width:18px;
        height:18px;
        clip-path: polygon(0 0, 0 100%, 100% 100%);
        background: var(--accent-color);
        color: var(--bg-color); display:flex;
        align-items:flex-end;
        font-size:11px;
        line-height: 1; 
        font-weight: 900; 
        letter-spacing: -0.3px; 
        padding:0 0 2px 3px;
        text-shadow: 0 1px 2px rgba(0,0,0,.8);
        -webkit-font-smoothing: antialiased;
        font-family: 'Noto Sans KR', sans-serif;
        z-index:1;
      }
      .heartMarker{
        position:absolute;
        left:50%;
        bottom:6px;
        transform: translateX(-50%);
        font-size:12px;
        color: var(--pink);
        opacity:.85; 
      }
      .heartMarker.full{
        opacity:1;
        text-shadow: 0 0 8px rgba(255,111,177,.25);
      }
      
      .doneBadge{
        position:absolute;
        right:0; bottom:0;
        width:18px; height:18px;
        clip-path: polygon(100% 0, 0 100%, 100% 100%);
        background: var(--today);
        color: var(--bg-color);
        display:flex;
        align-items:flex-end;
        justify-content:flex-end;
        font-size:11px;
        line-height: 1;
        font-weight: 900;
        letter-spacing: -0.3px;
        padding:0 3px 2px 0;
        text-shadow: 0 1px 2px rgba(0,0,0,.8);
        -webkit-font-smoothing: antialiased;
        font-family: 'Noto Sans KR', sans-serif;
        z-index:1;
      }
  
      .bottomBar{ position:absolute; left:0; right:0; bottom:0; height: var(--bottomBarH); padding:8px; border-top:2px solid var(--border-color); background: rgba(59, 66, 97, 0.2); display:flex; align-items:center; justify-content:space-between; }
      
      .modalBack{ position:absolute; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:10px; z-index:50; }
      .modalBack.show{ display:flex; }
      .modal{ width: 100%; max-width: 340px; height: 350px; background: #0e1016; border: 2px solid var(--border-color); display:flex; flex-direction:column; overflow:hidden; }
      .modalTaskList{ -ms-overflow-style:none; scrollbar-width:none; }
      .modalTaskList::-webkit-scrollbar{ display:none; }
    </style>
  </head>
  
  <body>
    <div class="stage">
      <div class="wrap">
        <div class="topbar">
          <div class="leftBtns">
            <button class="btn" id="prevBtn" title="ì´ì „ ë‹¬">&lt;</button>
            <button class="btn" id="todayBtn" title="ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ë™">TODAY</button>
          </div>
          <div class="monthTitle" id="monthTitle">LOADING...</div>
          <div class="rightBtns">
            <button class="btn" id="nextBtn" title="ë‹¤ìŒ ë‹¬">&gt;</button>
          </div>
        </div>
  
        <div class="dow">
          <div class="sunHead">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="satHead">í† </div>
        </div>
  
        <div class="grid" id="grid"></div>
  
        <div class="bottomBar">
          <span id="syncStatus" style="font-size:9px; color:var(--accent-color); opacity:0.8;">ë™ê¸°í™” ëŒ€ê¸°</span>
          <button class="btn" id="themeBtn">DARK</button>
        </div>
  
        <div class="modalBack" id="modalBack">
          <div class="modal">
            <div class="modalHeader" style="padding:10px; display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--border-color); background:#0b0c10; gap:8px;">
              <span id="modalTitle" style="font-size:10px; color:var(--accent-color);">í€˜ìŠ¤íŠ¸ ëª©ë¡</span>
              <span id="closeBtn" style="cursor:pointer; font-size:12px; padding:4px;" title="ë‹«ê¸° (Esc)">X</span>
            </div>
            <div class="modalAddRow" style="padding:8px; border-bottom:1px solid var(--border-color); display:flex; gap:6px;">
              <input type="text" id="modalTaskInput" placeholder="í•  ì¼ ì…ë ¥ í›„ Enter" style="flex:1; height:32px; border:1px solid var(--border-color); background:#0b0c10; color:var(--text-color); padding:0 8px; font-size:10px; font-family:'Noto Sans KR'; outline:none;" maxlength="60">
              <button id="modalAddBtn" style="width:60px; height:32px; border:1px solid var(--border-color); background:transparent; color:var(--accent-color); cursor:pointer; font-size:9px; font-family:'Silkscreen';">ì¶”ê°€</button>
            </div>
            <div id="taskList" class="modalTaskList" style="padding:10px; overflow-y:auto; flex:1; font-size:10px; min-height:0;"></div>
          </div>
        </div>
      </div>
    </div>
  
    <script>
      const $ = (s) => document.querySelector(s);
      const gridEl = $("#grid");
      const monthTitleEl = $("#monthTitle");
  
      // âœ… ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ?offline=1 â†’ Notion API í˜¸ì¶œ ì•ˆ í•¨ (íˆ¬ë‘ì™€ ë™ì¼ localStorage ì‚¬ìš©)
      const OFFLINE_MODE = window.location.search.includes('offline=1');
      const OFFLINE_KEY = "missionlog_offline_tasks_v1";
      function loadOfflineStore(){ try{ return JSON.parse(localStorage.getItem(OFFLINE_KEY)) || {}; }catch(_){ return {}; } }
      function setOfflineTasks(iso, arr){ const s = loadOfflineStore(); s[iso] = arr; localStorage.setItem(OFFLINE_KEY, JSON.stringify(s)); }
  
      let globalTasks = {}; 
      let globalEvents = {};
      let syncPaused = false;
      let syncInFlight = false;
  
      const state = {
        viewDate: new Date(),
        selectedISO: null
      };
  
      // â˜… [í•µì‹¬] íˆ¬ë‘ì™€ ë™ì¼í•œ ë‚ ì§œ í•¨ìˆ˜
  function getTodayISO() {  
    return new Date().toLocaleDateString('sv-SE', { timeZone: 'Asia/Seoul' });
  }
      // âœ… íˆ¬ë‘ pending ì €ì¥ì†Œ(ì„œë²„ fetch ì§€ì—° ëŒ€ë¹„)
const PENDING_KEY = "missionlog_pendingTasks_v1";

function loadPendingMap(){
  try{
    const obj = JSON.parse(localStorage.getItem(PENDING_KEY) || "{}");
    return (obj && typeof obj === "object") ? obj : {};
  }catch(_){
    return {};
  }
}

function getPendingTasksForISO(iso){
  const pending = loadPendingMap();
  const arr = Array.isArray(pending[iso]) ? pending[iso] : [];
  // âœ… ì•ˆì „í•˜ê²Œ date ì •ê·œí™”(í˜¹ì‹œ isoí‚¤ê°€ ë‹¤ë¥´ê²Œ ë“¤ì–´ì˜¨ ê²½ìš° ë°©ì–´)
  return arr
    .filter(t => String(t?.date || "").slice(0,10) === iso)
    .map(t => ({ ...t, _pending: true })); // í‘œì‹œìš© í”Œë˜ê·¸
}
  
      const bc = new BroadcastChannel("missionlog_bus_v1");
  
  // ê°™ì€ ì´ë²¤íŠ¸ê°€ ì—°ì†ìœ¼ë¡œ ì˜¬ ë•Œ 1ë²ˆë§Œ ì²˜ë¦¬(ê°€ë²¼ìš´ ì“°ë¡œí‹€)
  let _bcTimer = null;
  
    bc.onmessage = (ev) => {
      const t = ev?.data?.type;
    
      // âœ… íˆ¬ë‘/ì¼ì • ìœ„ì ¯ì—ì„œ "ì¶”ê°€ ì¦‰ì‹œ" ì˜¨ ê²½ìš°: pending ê¸°ë°˜ìœ¼ë¡œ ë°”ë¡œ ê°±ì‹ 
      if (t === "TASK_ADDED" || t === "EVENT_ADDED") {
        render();
        clearTimeout(_bcTimer);
        _bcTimer = setTimeout(() => { _bcTimer = null; syncFromNotion(); }, 250);
        return;
      }
    
      if (t !== "TASKS_UPDATED" && t !== "EVENTS_UPDATED") return;
    
      if (_bcTimer) return;
      _bcTimer = setTimeout(() => { _bcTimer = null; syncFromNotion(); }, 150);
    };
      
  
      function getHolidayName(iso) {
        const [y, m, d] = iso.split('-');
        const md = `${m}-${d}`;
        if (md === '01-01') return 'ì‹ ì •';
        if (md === '03-01') return '3.1ì ˆ';
        if (md === '05-05') return 'ì–´ë¦°ì´ë‚ ';
        if (md === '06-06') return 'í˜„ì¶©ì¼';
        if (md === '08-15') return 'ê´‘ë³µì ˆ';
        if (md === '10-03') return 'ê°œì²œì ˆ';
        if (md === '10-09') return 'í•œê¸€ë‚ ';
        if (md === '12-25') return 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤';
  
        const lunarMap = {
          '2026-02-16':'ì„¤ë‚ ', '2026-02-17':'ì„¤ë‚ ', '2026-02-18':'ì„¤ë‚ ', '2026-03-02':'ëŒ€ì²´ê³µíœ´ì¼', 
          '2026-05-06':'ëŒ€ì²´ê³µíœ´ì¼', '2026-05-24':'ì„ê°€íƒ„ì‹ ì¼', '2026-05-25':'ëŒ€ì²´ê³µíœ´ì¼', 
          '2026-09-24':'ì¶”ì„', '2026-09-25':'ì¶”ì„', '2026-09-26':'ì¶”ì„', '2026-09-27':'ëŒ€ì²´ê³µíœ´ì¼',
        };
        return lunarMap[iso];
      }
  
      const pad2 = (n) => String(n).padStart(2, "0");
      const toISO = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
      const DOW_KR = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      function getDowFromISO(iso){ const [y,m,d]=iso.split('-'); return DOW_KR[new Date(+y,+m-1,+d).getDay()]; }

          // âœ… [ì¶”ê°€] date/startê°€ stringì´ë“  objectë“  YYYY-MM-DD ë¬¸ìì—´ë¡œ ë½‘ê¸°
    function pickISODate(v){
      if (!v) return null;
      if (typeof v === "string") return v.slice(0,10);
    
      // Notion date object í˜•íƒœ ë°©ì–´: {start, end, ...}
      if (typeof v === "object") {
        if (typeof v.start === "string") return v.start.slice(0,10);
        if (v.date && typeof v.date.start === "string") return v.date.start.slice(0,10);
      }
      return null;
    }
    
    function pickISODateTime(v){
      if (!v) return null;
      if (typeof v === "string") return v; // "2026-02-01T10:00:00.000+09:00" ê°™ì€ í˜•íƒœ
      if (typeof v === "object") {
        if (typeof v.start === "string") return v.start;
        if (v.date && typeof v.date.start === "string") return v.date.start;
      }
      return null;
    }
      
      // âœ… done ê°’ì´ boolean/ë¬¸ìì—´/ì²´í¬ë°•ìŠ¤ ë“±ìœ¼ë¡œ ì„ì—¬ì™€ë„ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬
      function isDone(v){
        if (v === true) return true;
        if (v === false) return false;
      
        if (typeof v === "string") {
          return ["true","done","yes","1","ì™„ë£Œ"].includes(v.toLowerCase());
        }
        if (typeof v === "number") return v === 1;
      
        // {checkbox:true} ê°™ì€ í˜•íƒœ ë°©ì–´
        if (v && typeof v === "object") {
          if ("checkbox" in v) return !!v.checkbox;
          if ("value" in v) return !!v.value;
        }
        return false;
      }

          // âœ… pending events(ì„œë²„ ë°˜ì˜ ì „ ì„ì‹œ ì¼ì •) ì˜¤ë²„ë ˆì´
    const PENDING_EVENTS_KEY = "missionlog_pendingEvents_v1";
    
    function loadPendingEventsMap(){
      try{
        const obj = JSON.parse(localStorage.getItem(PENDING_EVENTS_KEY) || "{}");
        return (obj && typeof obj === "object") ? obj : {};
      }catch(_){
        return {};
      }
    }
    
    function getPendingEventsForISO(iso){
      const pending = loadPendingEventsMap();
      const arr = Array.isArray(pending[iso]) ? pending[iso] : [];
      return arr
        .filter(e => String(e?.start || "").slice(0,10) === iso)
        .map(e => ({ ...e, _pending: true }));
    }
      
  // âœ… [ì¶”ê°€] ì„œë²„ì— ëœ¬ í•­ëª©ì€ pendingì—ì„œ ì œê±°(ì¢€ë¹„ ë°©ì§€)
function prunePendingTasksByServer(serverTasksByISO){
  try{
    const pending = loadPendingMap(); // ìœ„ì— ì´ë¯¸ ìˆìŒ
    for (const iso of Object.keys(pending)) {
      const arr = Array.isArray(pending[iso]) ? pending[iso] : [];
      const serverArr = Array.isArray(serverTasksByISO[iso]) ? serverTasksByISO[iso] : [];

      pending[iso] = arr.filter(p => !serverArr.some(s => s.id === p.id || s.text === p.text));
      if (pending[iso].length === 0) delete pending[iso];
    }
    localStorage.setItem(PENDING_KEY, JSON.stringify(pending));
  }catch(_){}
}

function prunePendingEventsByServer(serverEventsByISO){
  try{
    const pending = loadPendingEventsMap(); // ìœ„ì— ì´ë¯¸ ìˆìŒ
    for (const iso of Object.keys(pending)) {
      const arr = Array.isArray(pending[iso]) ? pending[iso] : [];
      const serverArr = Array.isArray(serverEventsByISO[iso]) ? serverEventsByISO[iso] : [];

      pending[iso] = arr.filter(p => !serverArr.some(s =>
        (p?.id && s?.id && p.id === s.id) ||
        (String(p?.start || "").slice(0,16) === String(s?.start || "").slice(0,16) && (p?.title || "") === (s?.title || ""))
      ));
      if (pending[iso].length === 0) delete pending[iso];
    }
    localStorage.setItem(PENDING_EVENTS_KEY, JSON.stringify(pending));
  }catch(_){}
}

  
         async function syncFromNotion() {
    if (syncPaused) return;
    if (syncInFlight) return;
    syncInFlight = true;
  
    const statusEl = $("#syncStatus");
    if (statusEl) statusEl.textContent = OFFLINE_MODE ? "í…ŒìŠ¤íŠ¸ ëª¨ë“œ" : "ì—…ë°ì´íŠ¸ì¤‘...";
  
    if (OFFLINE_MODE) {
      const store = loadOfflineStore();
      globalTasks = {};
      for (const [iso, arr] of Object.entries(store)) {
        if (Array.isArray(arr) && arr.length) globalTasks[iso] = arr.map(t => ({ ...t, date: iso }));
      }
      globalEvents = {};
      if (statusEl) statusEl.textContent = "í…ŒìŠ¤íŠ¸ ëª¨ë“œ";
      syncInFlight = false;
      render();
      const back = $("#modalBack");
      if (back?.classList?.contains("show") && state.selectedISO) openModal(state.selectedISO);
      return;
    }
  
    const y = state.viewDate.getFullYear();
    const m = state.viewDate.getMonth();
    const firstDow = new Date(y, m, 1).getDay();
    const gridStart = new Date(y, m, 1 - firstDow);
    const gridEnd   = new Date(y, m, 42 - firstDow);
  
    const from = toISO(gridStart.getFullYear(), gridStart.getMonth() + 1, gridStart.getDate());
    const to   = toISO(gridEnd.getFullYear(),   gridEnd.getMonth() + 1,   gridEnd.getDate());
  
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), 8000);
  
    try {
    let res = await fetch('/api/notion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'fetch', from, to }),
      signal: ctrl.signal
    });
    
    // âœ… 1ì°¨ ì‹¤íŒ¨ë©´ from/to ì—†ì´ 1íšŒ ì¬ì‹œë„
    if (!res.ok) {
      res = await fetch('/api/notion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'fetch' }),
        signal: ctrl.signal
      });
    }
    
    // âœ… 2ì°¨ë„ ì‹¤íŒ¨ë©´ ì—¬ê¸°ì„œ ì¢…ë£Œ
    if (!res.ok) {
      console.error("API HTTP error:", res.status);
      if (statusEl) statusEl.textContent = `ë™ê¸°í™” ì‹¤íŒ¨(HTTP ${res.status})`;
      return;
    }
  
      const data = await res.json().catch(() => null);
      if (!data?.success) {
        console.error("API payload error:", data);
        if (statusEl) statusEl.textContent = "ë™ê¸°í™” ì‹¤íŒ¨(payload)";
        return;
      }
  
    const newTasks = {};
    (data.tasks || []).forEach(t => {
      const d = pickISODate(t?.date);
      if (!d) return;
      (newTasks[d] ||= []).push(t);
    });
    
    const newEvents = {};
    (data.events || []).forEach(e => {
      const iso = pickISODate(e?.start);
      if (!iso) return;
    
      // (ì„ íƒ) ëª¨ë‹¬ì—ì„œ ì‹œê°„ ì •ë ¬í•˜ë ¤ë©´ start ì›ë³¸ë„ í†µì¼í•´ì„œ ë“¤ê³ ê°€ë„ ë¨
      // e._startDT = pickISODateTime(e?.start);
    
      (newEvents[iso] ||= []).push(e);
    });
    
      // âœ… [ì—¬ê¸° ì¶”ê°€] ì„œë²„ì— ëœ¬ ì• ë“¤ì€ pendingì—ì„œ ì œê±°
      prunePendingTasksByServer(newTasks);
      prunePendingEventsByServer(newEvents);
    
      globalTasks = newTasks;
      globalEvents = newEvents;
    
      if (statusEl) statusEl.textContent = "ë™ê¸°í™” ì™„ë£Œ";
    } catch (e) {
      console.error("syncFromNotion failed:", e);
      if (statusEl) statusEl.textContent = "ë™ê¸°í™” ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬)";
    } finally {
      clearTimeout(timer);
      syncInFlight = false;              // âœ… ì ê¸ˆ í•´ì œ
      render();
  
      const back = $("#modalBack");
      if (back?.classList?.contains("show") && state.selectedISO) {
        openModal(state.selectedISO);
      }
    }
  }
  
  
      
      function render() {
    if (!gridEl || !monthTitleEl) return; // âœ… DOM ëˆ„ë½ ë°©ì–´
    gridEl.innerHTML = "";
  
    const y = state.viewDate.getFullYear();
    const m = state.viewDate.getMonth();
    monthTitleEl.textContent = `${y}-${pad2(m+1)}`;
  
    const firstDow = new Date(y, m, 1).getDay();
    const lastDay  = new Date(y, m + 1, 0).getDate();
    const prevLast = new Date(y, m, 0).getDate();
  
    for (let i = 0; i < 42; i++) {
      const cell = document.createElement("div");
      cell.className = "day";
  
      const dayNum = i - firstDow + 1;
      let d, disabled = false;
  
      if (dayNum < 1) {
        d = new Date(y, m - 1, prevLast + dayNum);
        disabled = true;
      } else if (dayNum > lastDay) {
        d = new Date(y, m + 1, dayNum - lastDay);
        disabled = true;
      } else {
        d = new Date(y, m, dayNum);
      }
  
      const iso = toISO(d.getFullYear(), d.getMonth() + 1, d.getDate());
      const dow = d.getDay();
      const holidayName = getHolidayName(iso);
  
      if (disabled) cell.classList.add("disabled");
  
      if (dow === 0 || holidayName) {
        cell.classList.add("sun");
        if (holidayName) cell.title = holidayName;
      }
      if (dow === 6 && !holidayName) cell.classList.add("sat");
  
      if (iso === getTodayISO() && !disabled) cell.classList.add("today");
  
      const num = document.createElement("div");
      num.className = "num";
      num.textContent = d.getDate();
      cell.appendChild(num);
  
    // âœ… ì¼ì • '!' (ì„œë²„ + pending)
    const eventsServer = globalEvents[iso] || [];
    const eventsPending = getPendingEventsForISO(iso);
    const eventsAll = [...eventsServer, ...eventsPending];
    
    if (eventsAll.length > 0) {
      const mark = document.createElement("div");
      mark.className = "eventMark";
      mark.textContent = "!";
      cell.appendChild(mark);
    }
  
      // âœ… í€˜ìŠ¤íŠ¸ ë°°ì§€
        const tasksServer = globalTasks[iso] || [];
        const tasksPending = getPendingTasksForISO(iso);
        const tasksAll = [...tasksServer, ...tasksPending];
        
        if (tasksAll.length > 0) {
        const badge = document.createElement("div");
        badge.className = "todoBadge";
        badge.textContent = tasksAll.length;
        cell.appendChild(badge);
  
        const doneCount = tasksAll.reduce((acc, t) => acc + (isDone(t?.done) ? 1 : 0), 0);  
        if (doneCount > 0) {
          cell.classList.add("hasDone");
  
          const doneBadge = document.createElement("div");
          doneBadge.className = "doneBadge";
          doneBadge.textContent = doneCount;
          cell.appendChild(doneBadge);
        }
  
        const allDone = doneCount === tasksAll.length;
        const heart = document.createElement("div");
        heart.className = "heartMarker";
        heart.textContent = allDone ? "â™¥" : "â™¡";
        heart.classList.toggle("full", allDone);
        cell.appendChild(heart);
      }
  
      cell.onclick = () => { if (!disabled) openModal(iso); };
      gridEl.appendChild(cell);
    }
  }
  
  
  
  // âœ… render() ë°”ê¹¥ì— ìˆì–´ì•¼ í•¨
  function openModal(iso) {
    state.selectedISO = iso;
    const holidayName = getHolidayName(iso);
    const dow = getDowFromISO(iso);
    const mt = $("#modalTitle");
    if (mt) mt.textContent = holidayName ? `${iso} (${dow}) ${holidayName}` : `${iso} (${dow})`;
    const modalInput = $("#modalTaskInput");
    const modalAddBtn = $("#modalAddBtn");
    if (modalInput) modalInput.value = "";
    if (modalInput) modalInput.placeholder = "í•  ì¼ ì…ë ¥ í›„ Enter";
    $("#modalBack").classList.add("show");
    setTimeout(() => $("#modalTaskInput")?.focus(), 50);
    const list = $("#taskList");
    if (!list) return;
    list.innerHTML = "";
    // ===== âœ… ì¼ì • ì„¹ì…˜ =====
  const events = [...(globalEvents[iso] || []), ...getPendingEventsForISO(iso)].slice();
  
  // ì‹œê°„ í‘œì‹œìš©(ìˆìœ¼ë©´ HH:MM ë½‘ê¸°)
  const fmtTime = (s) => {
    if (!s) return "";
    const t = String(s);
    const m = t.match(/T(\d{2}:\d{2})/);
    return m ? m[1] : "";
  };
  
  if (events.length > 0) {
    events.sort((a,b) => String(a.start).localeCompare(String(b.start)));
  
    const header = document.createElement("div");
    header.style.margin = "0 0 8px";
    header.style.color = "rgba(233,238,247,.85)";
    header.textContent = "ğŸ“Œ ì¼ì •";
    list.appendChild(header);
  
    events.forEach(e => {
      const row = document.createElement("div");
      row.style.padding = "5px 0";
      row.style.opacity = "0.95";
  
      const st = fmtTime(e.start);
      const en = fmtTime(e.end);
      const timeTxt = (st || en) ? `${st || "??:??"}-${en || "??:??"} ` : "";
  
      row.textContent = `â€¢ ${timeTxt}${e.title || "ì¼ì •"}`;
      list.appendChild(row);
    });
  
    const divLine = document.createElement("div");
    divLine.style.margin = "8px 0";
    divLine.style.borderTop = "1px solid rgba(233,238,247,.18)";
    list.appendChild(divLine);
  }
  
      const tasksServer = globalTasks[iso] || [];
    const tasksPending = getPendingTasksForISO(iso);
    const tasks = [...tasksServer, ...tasksPending];
      
  // âœ… ì¼ì •ë„ ì—†ê³ , í€˜ìŠ¤íŠ¸ë„ ì—†ì„ ë•Œ
  if (events.length === 0 && tasks.length === 0) {
    const empty = document.createElement("div");
    empty.style.color = "var(--accent-color)";
    empty.style.fontSize = "10px";
    empty.textContent = "ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•´ë³´ì„¸ìš”.";
    list.appendChild(empty);
    return;
  }
  
  if (tasks.length === 0) return;
  
  tasks.forEach((t, idx) => {
    const div = document.createElement("div");
    div.style.padding = "6px 8px";
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.gap = "8px";
    div.style.cursor = "pointer";
    div.style.border = "1px solid transparent";
    div.style.borderRadius = "0";
    div.addEventListener("mouseenter", () => { div.style.borderColor = "var(--accent-color)"; div.style.background = "rgba(130,170,255,0.15)"; });
    div.addEventListener("mouseleave", () => { div.style.borderColor = "transparent"; div.style.background = "transparent"; });
    const icon = isDone(t?.done) ? "âœ…" : (t._pending ? "â³" : "â¬œ");
    const span = document.createElement("span");
    span.textContent = `${icon} ${t.text}`;
    if (isDone(t?.done)) span.style.textDecoration = "line-through";
    if (isDone(t?.done)) span.style.opacity = "0.7";
    div.appendChild(span);
    div.onclick = () => calendarToggleTask(iso, t, idx);
    list.appendChild(div); 
  });
  }
  
  async function calendarAddTask() {
    const iso = state.selectedISO;
    const input = $("#modalTaskInput");
    if (!iso || !input) return;
    const text = input.value.trim();
    if (!text) return;
    if (OFFLINE_MODE) {
      const arr = (globalTasks[iso] || []).slice();
      arr.unshift({ id: "off-" + Date.now(), text, done: false, date: iso });
      globalTasks[iso] = arr;
      setOfflineTasks(iso, arr);
      bc.postMessage({ type: "TASK_ADDED", task: { text, date: iso } });
      bc.postMessage({ type: "TASKS_UPDATED" });
      openModal(iso);
      return;
    }
    try {
      const res = await fetch("/api/notion", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "create", text, date: iso })
      });
      const data = await res.json().catch(() => null);
      if (data?.success) {
        try {
          const pending = loadPendingMap();
          (pending[iso] ||= []).unshift({ id: data.id, text, done: false, date: iso });
          localStorage.setItem(PENDING_KEY, JSON.stringify(pending));
        } catch (_) {}
        bc.postMessage({ type: "TASK_ADDED", task: { text, date: iso } });
        bc.postMessage({ type: "TASKS_UPDATED" });
        syncFromNotion();
        openModal(iso);
      }
    } catch (e) { console.error(e); }
  }

  async function calendarToggleTask(iso, task, idx) {
    if (OFFLINE_MODE) {
      const arr = (globalTasks[iso] || []).slice();
      const i = arr.findIndex(x => (x.id === task.id) || (x.text === task.text && !x.id && !task.id));
      if (i >= 0) arr[i].done = !arr[i].done;
      globalTasks[iso] = arr;
      setOfflineTasks(iso, arr);
      bc.postMessage({ type: "TASKS_UPDATED" });
      openModal(iso);
      return;
    }
    if (!task?.id || String(task.id).startsWith("temp-") || String(task.id).startsWith("off-")) return;
    try {
      const res = await fetch("/api/notion", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "update", pageId: task.id, done: !isDone(task.done) })
      });
      const data = await res.json().catch(() => null);
      if (data?.success) {
        bc.postMessage({ type: "TASKS_UPDATED" });
        syncFromNotion();
        openModal(iso);
      }
    } catch (e) { console.error(e); }
  }

  const modalBack = $("#modalBack");
  $("#closeBtn").onclick = () => modalBack.classList.remove("show");
  $("#modalAddBtn").onclick = calendarAddTask;
  $("#modalTaskInput").onkeydown = (e) => {
    if (e.key === "Enter") { e.preventDefault(); calendarAddTask(); }
    if (e.key === "Escape") modalBack.classList.remove("show");
  };
  modalBack.addEventListener("click", (e) => { if (e.target === modalBack) modalBack.classList.remove("show"); });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalBack.classList.contains("show")) modalBack.classList.remove("show");
  });
  
  function bumpMonth(delta){
    state.viewDate.setMonth(state.viewDate.getMonth() + delta);
    render();
    syncFromNotion();
  }  
    
  $("#prevBtn").onclick = () => bumpMonth(-1);
  $("#nextBtn").onclick = () => bumpMonth(+1);
  $("#todayBtn").onclick = () => {
    state.viewDate = new Date();
    render();
    syncFromNotion();
  };
  
  // âœ… ì´ˆê¸° ì§„ì…: ë¼ˆëŒ€ ë¨¼ì € + ì¦‰ì‹œ ë™ê¸°í™”
  render();
  syncFromNotion();
  
  // âœ… ì£¼ê¸° ë™ê¸°í™”(ì „ì—­ì—ì„œ ë”± 1ë²ˆë§Œ)
  setInterval(syncFromNotion, 15000);
    </script>
  </body>
  </html>
  
  
  
  
  
  
  
  



